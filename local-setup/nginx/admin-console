#
# NGNIX set up for local.
#

# For websocket proxying
#
# http://nginx.org/en/docs/http/websocket.html

map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
}

upstream backend {
  server localhost:4041 fail_timeout=10000; # local backend
}

upstream ui {
  server localhost:4042 fail_timeout=1000; # local react yarn
}

upstream authserver {
  server localhost:20241 fail_timeout=10000; # local backend
}

server {
  listen 5000;
  server_name     localhost;
  resolver 192.168.10.1 8.8.8.8 8.8.4.4 valid=300s;
  resolver_timeout 5s;
  add_header Strict-Transport-Security "max-age=63072000; includeSubdomains";
  add_header X-Frame-Options DENY;
  # add_header X-Content-Type-Options nosniff;
  root /var/www/html;

  error_page 404 /arxiv/404.html;
  error_page 500 502 503 504 /arxiv/500.html;
  access_log      /var/log/nginx/admin-console/access.log ;
  error_log       /var/log/nginx/admin-console/error.log  ;

  # authn, and account
  location ^~ /aaa {
    # Remove /aaa from the URL if needed
    rewrite ^/aaa(.*)$ $1 break;

    # Don't send any file out
    sendfile off;
    #
    proxy_pass     http://authserver;
    # Required for new HTTP-based CLI
    proxy_http_version 1.1;
    # Don't want any buffering
    proxy_request_buffering off;
    proxy_buffering off;

    proxy_set_header        Host $host:$server_port;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        X-Forwarded-Proto $scheme;
    # Ensure headers are not stripped
    proxy_pass_header Set-Cookie;
  }

  # route to my backend
  location ^~ /adminapi {
    # Remove /api from the URL if needed
    # rewrite ^/adminapi(.*)$ $1 break;

    # Proxy to the backend server
    proxy_pass http://backend;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_set_header Host $host:$server_port;
    proxy_set_header Cookie $http_cookie;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_pass_header Set-Cookie;
    proxy_read_timeout 600s;
    proxy_request_buffering off;
    proxy_pass_request_headers on;
    proxy_buffering off;

    # Ensure no static files are served from /api route
    sendfile off;  
  }

  # This is dev web socket io
  location /websocketio {
    proxy_pass http://ui;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_set_header Host $host;
    # Ensure headers are not stripped
    proxy_pass_header Set-Cookie;
    proxy_read_timeout 600s;
    proxy_request_buffering off;
    proxy_buffering off;
  }
  
  location ^~ /src/ {
    # You'd probably want to chanege this
    alias /home/ntai/arxiv/admin-webapp/arxiv-admin-console/src/;
  }
  
  location ^~ /admin-console {
    # rewrite ^/admin-console(.*)$ $1 break;
    # React uses statics
    # sendfile on;
    #
    proxy_pass     http://ui;
    # proxy_redirect http://localhost:5000 http://localhost:4042;
    # Required for new HTTP-based CLId
    proxy_http_version 1.1;
    # Don't want any buffering
    proxy_request_buffering off;
    proxy_buffering off;
    # this is the maximum upload size
    client_max_body_size       10m;
    client_body_buffer_size    128k;
    # downstream nginx doesn't like the port/uri in the host header
    # proxy_set_header        Host $host:$server_port$uri;
    proxy_set_header        Host $host;
    proxy_set_header        X-Real-IP $remote_addr;
    proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header        X-Forwarded-Proto $scheme;
    # Ensure headers are not stripped
    proxy_pass_header Set-Cookie;
  }
}
